# AIチャット機能の詳細仕様書

## 1. 概要

マンション理事会管理システムのAIチャット機能は、理事会に関する質問に対してRAG（Retrieval-Augmented Generation）技術を使用してマンション管理規約に基づく回答を提供するシステムです。

## 2. システム構成

### 2.1 フロントエンド
- **ファイル**: `client/src/components/Chat.tsx`
- **フレームワーク**: React + TypeScript
- **UIライブラリ**: カスタムスタイル

### 2.2 バックエンド API
- **フレームワーク**: Node.js + Express + TypeScript
- **AIサービス**: OpenAI GPT-4o-mini
- **ベクトルデータベース**: Supabase (pgvector)
- **検索エンジン**: Embedding-based similarity search

## 3. 機能仕様

### 3.1 チャット機能の基本フロー

1. **ユーザー質問入力** (`Chat.tsx:10-19`)
   - テキスト入力フィールドでユーザーが質問を入力
   - Enterキーまたは送信ボタンで送信

2. **二段階処理システム**

   **第一段階: フロントエンド検索** (`Chat.tsx:22-234`)
   - `searchDocuments` API呼び出し
   - 検索結果の前処理とフィルタリング
   - 検索結果の可視化

   **第二段階: AI回答生成** (`Chat.tsx:236-265`)
   - `sendChatMessage` API呼び出し
   - バックエンドでRAG検索実行
   - AI回答の生成と表示

### 3.2 検索機能 (`server/routes/search.ts`)

**エンドポイント**: `POST /api/search`

**パラメータ**:
- `question`: 検索クエリ（必須）
- `matchThreshold`: 類似度閾値（デフォルト: 0.2）
- `matchCount`: 取得件数（デフォルト: 10）

**処理フロー**:
1. OpenAI `text-embedding-ada-002`でクエリをベクトル化
2. Supabase `match_regulation_chunks` RPC関数で類似検索
3. 検索結果を返却

### 3.3 AI回答生成機能 (`server/routes/openai.ts`)

**エンドポイント**: `POST /api/openai/chat`

**主要機能**:

1. **RAG検索統合** (`openai.ts:29-129`)
   - 質問のembedding生成
   - Supabaseでベクトル検索実行
   - 検索結果のフィルタリングとランキング

2. **高度なフィルタリングロジック** (`openai.ts:60-106`)
   - **定義文優先**: `[一二三四五六七八九十]\s+[^。]+\s+[^。]*をいう`パターン
   - **条文検出**: `第\d+条`パターン
   - **キーワードマッチスコア**: 複合キーワードサポート
   - **総合スコア算出**: `similarity * 0.3 + keywordScore * 0.7`

3. **コンテキスト生成** (`openai.ts:131-153`)
   - システムメッセージでRAGコンテキストを提供
   - 専門用語の説明を促すプロンプト設計

### 3.4 フロントエンド検索結果処理 (`Chat.tsx:42-209`)

**高度なフィルタリング機能**:

1. **条文判定**: `第○条`を含む文書
2. **定義文判定**: 「○ キーワード 説明文」形式
3. **住戸リスト除外**: 別表第3、4や連続する住戸番号
4. **キーワードマッチスコア**: 複合キーワードボーナス
5. **関連部分抽出**: 番号付きリストや条文の抽出

**表示形式**:
- 類似度パーセンテージ
- キーワード適合度
- 文書タイプ（定義文/条文/住戸リスト）
- 関連部分のプレビュー

## 4. エンドポイント一覧

### 4.1 チャット関連
- `POST /api/openai/chat` - AI回答生成（RAG統合）
- `POST /api/search` - 文書検索
- `POST /api/ask` - 旧形式のAI質問（現在は使用していない）

### 4.2 その他AI機能
- `POST /api/openai/summarize-minutes` - 議事録要約
- `POST /api/openai/suggest-agendas` - 議題提案

## 5. データベース仕様

### 5.1 ベクトル検索
- **RPC関数**: `match_regulation_chunks`
- **パラメータ**:
  - `query_embedding`: クエリのembeddingベクトル
  - `match_threshold`: 類似度閾値
  - `match_count`: 取得件数

### 5.2 検索結果フィールド
- `chunk`: 文書チャンク
- `similarity`: 類似度スコア
- その他のメタデータ

## 6. UI/UX仕様

### 6.1 チャット画面構成
- **ヘッダー**: タイトル、クリアボタン、認証確認ボタン
- **メッセージエリア**: スクロール可能なメッセージ履歴
- **入力エリア**: テキスト入力フィールドと送信ボタン

### 6.2 メッセージタイプ
- **ユーザーメッセージ**: 青色、右寄せ
- **AIアシスタント**: 白色、左寄せ、ボーダー付き
- **検索結果**: 薄青色、枠線付き、特別なフォント

### 6.3 ローディング状態
- **検索中**: 「関連する規約・文書を検索中...」
- **AI応答中**: 「考え中...」アニメーション

## 7. セキュリティ・認証

### 7.1 認証方式
- JWT トークンベース認証
- LocalStorageにトークン保存
- 全APIリクエストにBearerトークン付加

### 7.2 権限管理
- ログイン済みユーザーのみアクセス可能
- 認証確認機能付き

## 8. パフォーマンス最適化

### 8.1 検索最適化
- 類似度閾値による結果フィルタリング
- 取得件数制限（デフォルト10件）
- 関連性スコアによる再ランキング

### 8.2 UI最適化
- 非同期処理による段階的表示
- 検索とAI回答の並列処理
- リアルタイムローディング状態表示

## 9. 設定・環境変数

### 9.1 必須環境変数
- `OPENAI_API_KEY`: OpenAI APIキー
- `SUPABASE_URL`: SupabaseプロジェクトURL
- `SUPABASE_KEY`: Supabaseサービスキー

### 9.2 フロントエンド設定
- `REACT_APP_API_URL`: バックエンドAPIベースURL

## 10. エラーハンドリング

### 10.1 検索エラー
- 検索API失敗時のフォールバック
- エラーメッセージの表示

### 10.2 AI回答エラー
- OpenAI API失敗時のエラー処理
- ユーザーフレンドリーなエラーメッセージ

## 11. 技術的詳細

### 11.1 フロントエンド実装詳細

#### メッセージ管理
```typescript
const [messages, setMessages] = useState<any[]>([]);
const [input, setInput] = useState("");
const [loading, setLoading] = useState(false);
const [searchLoading, setSearchLoading] = useState(false);
```

#### 検索結果フィルタリングアルゴリズム
1. **条文判定**: `/第\d+条/`パターンマッチ
2. **定義文判定**: `/[一二三四五六七八九十]\s+[^。]+\s+[^。]*をいう/`パターン
3. **住戸リスト判定**: `/別表第[3-4]/`、`/\d{3}号室/`パターン
4. **キーワードスコア計算**: 
   - 基本マッチ: +1.0点
   - 複合キーワード: +2.0点
   - 定義文ボーナス: +10.0点
   - 条文ボーナス: +5.0点
   - 住戸リストペナルティ: -3.0点

#### 総合スコア算出
```typescript
const combinedScore = result.similarity * 0.3 + keywordScore * 0.7;
```

### 11.2 バックエンド実装詳細

#### RAG検索フロー
1. **Embedding生成**: OpenAI `text-embedding-ada-002`
2. **ベクトル検索**: Supabase RPC `match_regulation_chunks`
3. **結果フィルタリング**: 定義文・条文優先ロジック
4. **コンテキスト構築**: 検索結果をシステムメッセージに統合

#### プロンプト設計
```typescript
const systemMessage = {
  role: 'system',
  content: `あなたはマンション理事会の専門アシスタントです。以下の関連文書を参考に、自然で分かりやすい日本語で回答してください。

関連文書：
${ragContext}

回答時の注意点：
- 専門用語は分かりやすく説明する
- 具体例を交えて説明する
- 必要に応じて条文番号や根拠を明示する
- 簡潔で親しみやすい口調で回答する`
};
```

## 12. 今後の拡張予定

### 12.1 機能拡張
- 音声入力対応
- 画像・PDF添付による質問
- 会話履歴の保存・検索
- 多言語対応

### 12.2 性能改善
- キャッシュ機能の実装
- レスポンス時間の最適化
- より高精度な検索アルゴリズム

### 12.3 UI/UX改善
- モバイル対応の強化
- ダークモード対応
- カスタマイズ可能なテーマ

---

**作成日**: 2025年1月19日  
**バージョン**: 1.0  
**システム**: マンション理事会管理システム  
**担当**: AI開発チーム