# マンション理事会管理システム 詳細仕様書

## 1. システム概要

### 1.1 システム名
マンション理事会管理システム（p05）

### 1.2 目的
マンション理事会の運営を効率化し、会議の開催・議題管理・出席管理・文書管理を統合的に行うWebアプリケーション

### 1.3 システムアーキテクチャ
- **フロントエンド**: React 18.2.0 + TypeScript
- **バックエンド**: Node.js + Express 4.18.2
- **データベース**: PostgreSQL（本番）/ SQLite（開発）
- **認証**: JWT（JSON Web Token）
- **ファイル管理**: Multer
- **デプロイ**: GitHub Pages

### 1.4 開発環境
- Node.js 16+
- TypeScript 4.9+
- React 18.2+
- Express 4.18+
- PostgreSQL 8.11+

## 2. システム構成

### 2.1 ディレクトリ構造
```
p05/
├── client/                    # フロントエンド
│   ├── src/
│   │   ├── components/        # Reactコンポーネント
│   │   ├── contexts/          # Context API
│   │   ├── types/             # TypeScript型定義
│   │   ├── utils/             # ユーティリティ関数
│   │   └── App.tsx            # メインアプリケーション
│   ├── public/                # 静的ファイル
│   └── package.json
├── server/                    # バックエンド
│   ├── routes/                # APIルート
│   ├── uploads/               # ファイルアップロード
│   ├── app.ts                 # TypeScript版サーバー
│   ├── index.js               # JavaScript版サーバー
│   ├── database.js            # データベース管理
│   └── database.sql           # データベーススキーマ
├── package.json               # ルートパッケージ管理
├── CLAUDE.md                  # プロジェクト説明
└── README.md                  # プロジェクト概要
```

### 2.2 ポート設定
- **フロントエンド**: 3105
- **バックエンド**: 5105
- **本番環境**: 単一ポート（バックエンドがフロントエンドを配信）

## 3. データベース設計

### 3.1 テーブル構成

#### 3.1.1 users（ユーザー）
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL CHECK (role IN ('admin', 'chairperson', 'board_member', 'resident')),
    room_number VARCHAR(20),
    phone VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.1.2 meetings（理事会）
```sql
CREATE TABLE meetings (
    id SERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    date TIMESTAMP,
    time_start TIME,
    time_end TIME,
    location VARCHAR(200),
    description TEXT,
    status VARCHAR(20) DEFAULT 'tentative' CHECK (status IN ('confirmed', 'tentative', 'completed', 'cancelled')),
    meeting_type VARCHAR(20) DEFAULT 'regular' CHECK (meeting_type IN ('regular', 'emergency')),
    created_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.1.3 agendas（議題）
```sql
CREATE TABLE agendas (
    id SERIAL PRIMARY KEY,
    meeting_id INTEGER REFERENCES meetings(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    order_no INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'discussed', 'approved', 'rejected')),
    created_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.1.4 meeting_attendance（出席管理）
```sql
CREATE TABLE meeting_attendance (
    id SERIAL PRIMARY KEY,
    meeting_id INTEGER REFERENCES meetings(id) ON DELETE CASCADE,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    member_name VARCHAR(100),
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'attending', 'absent', 'maybe')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(meeting_id, user_id)
);
```

#### 3.1.5 documents（文書管理）
```sql
CREATE TABLE documents (
    id SERIAL PRIMARY KEY,
    meeting_id INTEGER REFERENCES meetings(id) ON DELETE CASCADE,
    agenda_id INTEGER REFERENCES agendas(id) ON DELETE CASCADE,
    filename VARCHAR(255) NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INTEGER,
    mime_type VARCHAR(100),
    uploaded_by INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.1.6 association_master（組合情報）
```sql
CREATE TABLE association_master (
    id SERIAL PRIMARY KEY,
    association_code VARCHAR(20) UNIQUE NOT NULL,
    association_name VARCHAR(200) NOT NULL,
    chairperson_name VARCHAR(100) NOT NULL,
    meeting_frequency INTEGER NOT NULL CHECK (meeting_frequency IN (1, 2, 3, 4)),
    meeting_week INTEGER CHECK (meeting_week IN (1, 2, 3, 4)),
    meeting_day_of_week INTEGER CHECK (meeting_day_of_week IN (0, 1, 2, 3, 4, 5, 6)),
    meeting_start_time TIME,
    meeting_end_time TIME,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.1.7 その他のテーブル
- **meeting_minutes**: 議事録管理
- **garbage_schedule**: ゴミカレンダー
- **announcements**: お知らせ
- **agenda_comments**: 議題コメント
- **email_notifications**: メール通知履歴

### 3.2 サンプルデータ
```sql
-- デフォルトユーザー（すべて password: password）
INSERT INTO users (name, email, password, role, room_number) VALUES
('管理者', 'admin@mansion.com', '$2a$10$...', 'admin', '管理室'),
('理事長', 'chairperson@mansion.com', '$2a$10$...', 'chairperson', '101'),
('理事', 'board@mansion.com', '$2a$10$...', 'board_member', '201'),
('住民', 'resident@mansion.com', '$2a$10$...', 'resident', '301');
```

## 4. API仕様

### 4.1 認証API

#### 4.1.1 ログイン
```
POST /api/auth/login
Content-Type: application/json

{
  "email": "admin@mansion.com",
  "password": "password"
}

Response:
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "name": "管理者",
    "email": "admin@mansion.com",
    "role": "admin",
    "room_number": "管理室"
  }
}
```

### 4.2 理事会管理API

#### 4.2.1 理事会一覧取得
```
GET /api/meetings
Authorization: Bearer <token>

Response:
[
  {
    "id": 1,
    "title": "2024年1月定例理事会",
    "date": "2024-01-15T14:00:00Z",
    "time_start": "14:00",
    "time_end": "16:00",
    "location": "マンション集会室",
    "description": "定例理事会",
    "status": "confirmed",
    "meeting_type": "regular",
    "created_by": 1,
    "created_at": "2024-01-01T10:00:00Z",
    "updated_at": "2024-01-01T10:00:00Z"
  }
]
```

#### 4.2.2 理事会作成
```
POST /api/meetings
Authorization: Bearer <token>
Content-Type: application/json

{
  "title": "2024年2月定例理事会",
  "date": "2024-02-15T14:00:00Z",
  "time_start": "14:00",
  "time_end": "16:00",
  "location": "マンション集会室",
  "description": "定例理事会",
  "status": "tentative",
  "meeting_type": "regular"
}
```

#### 4.2.3 理事会更新
```
PUT /api/meetings/:id
Authorization: Bearer <token>
Content-Type: application/json

{
  "title": "2024年2月定例理事会（更新）",
  "status": "confirmed"
}
```

#### 4.2.4 理事会削除
```
DELETE /api/meetings/:id
Authorization: Bearer <token>
```

### 4.3 議題管理API

#### 4.3.1 議題一覧取得
```
GET /api/agendas/:meetingId
Authorization: Bearer <token>

Response:
[
  {
    "id": 1,
    "meeting_id": 1,
    "title": "修繕計画について",
    "description": "外壁修繕の計画と予算について",
    "order_no": 1,
    "status": "pending",
    "created_by": 1,
    "created_at": "2024-01-01T10:00:00Z",
    "updated_at": "2024-01-01T10:00:00Z"
  }
]
```

#### 4.3.2 議題作成
```
POST /api/agendas
Authorization: Bearer <token>
Content-Type: application/json

{
  "meeting_id": 1,
  "title": "修繕計画について",
  "description": "外壁修繕の計画と予算について",
  "order_no": 1
}
```

### 4.4 出席管理API

#### 4.4.1 出席状況取得
```
GET /api/meetings/:meetingId/attendance
Authorization: Bearer <token>

Response:
[
  {
    "id": 1,
    "meeting_id": 1,
    "user_id": 1,
    "member_name": "管理者",
    "status": "attending",
    "created_at": "2024-01-01T10:00:00Z"
  }
]
```

#### 4.4.2 出席状況更新
```
POST /api/meetings/:meetingId/attendance
Authorization: Bearer <token>
Content-Type: application/json

{
  "status": "attending",
  "userId": 1
}
```

### 4.5 ファイル管理API

#### 4.5.1 ファイルアップロード
```
POST /api/agendas/:agendaId/documents/upload
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <binary data>
```

#### 4.5.2 ファイルダウンロード
```
GET /api/files/:fileId/download
Authorization: Bearer <token>
```

### 4.6 ユーザー管理API（管理者のみ）

#### 4.6.1 ユーザー一覧取得
```
GET /api/users
Authorization: Bearer <token>
```

#### 4.6.2 ユーザー作成
```
POST /api/users
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "新規ユーザー",
  "email": "new@mansion.com",
  "password": "password",
  "role": "resident",
  "room_number": "401"
}
```

## 5. フロントエンド仕様

### 5.1 技術スタック
- **React**: 18.2.0
- **TypeScript**: 4.9.5
- **React Router**: 6.20.1
- **Axios**: 1.6.2
- **date-fns**: 2.30.0（日付処理）
- **react-hook-form**: 7.48.2（フォーム管理）
- **react-calendar**: 4.8.0（カレンダー表示）
- **lucide-react**: 0.294.0（アイコン）

### 5.2 コンポーネント構成

#### 5.2.1 メインコンポーネント
- **App.tsx**: メインアプリケーション・ルーティング
- **Layout.tsx**: 基本レイアウト
- **Navigation.tsx**: ナビゲーション
- **Dashboard.tsx**: ダッシュボード

#### 5.2.2 認証コンポーネント
- **Login.tsx**: ログイン画面
- **ProtectedRoute.tsx**: 認証保護ルート

#### 5.2.3 理事会管理コンポーネント
- **BoardMeetingSchedule.tsx**: 理事会スケジュール
- **MeetingManagement.tsx**: 理事会管理
- **BoardMeetingManagement.tsx**: 理事会運営

#### 5.2.4 議題管理コンポーネント
- **AgendaManagement.tsx**: 議題管理
- **AgendaRegistration.tsx**: 議題登録

#### 5.2.5 管理者コンポーネント
- **UserManagement.tsx**: ユーザー管理
- **RoleManagement.tsx**: 役割管理
- **AssociationMaster.tsx**: 組合情報管理

### 5.3 状態管理

#### 5.3.1 Context API
```typescript
// AuthContext.tsx
interface AuthContextValue {
  user: User | null;
  login: (token: string) => Promise<void>;
  logout: () => void;
  loading: boolean;
}
```

#### 5.3.2 ローカル状態管理
- **useState**: コンポーネント状態
- **useEffect**: 副作用管理
- **useContext**: グローバル状態アクセス

### 5.4 型定義

#### 5.4.1 主要型定義
```typescript
// types/index.ts
export interface User {
  id: number;
  name: string;
  email: string;
  role: 'admin' | 'chairperson' | 'board_member' | 'resident';
  room_number?: string;
  phone?: string;
}

export interface Meeting {
  id: number;
  title: string;
  date: string;
  time_start: string;
  time_end: string;
  location: string;
  description: string;
  status: 'confirmed' | 'tentative' | 'completed' | 'cancelled';
  meeting_type: 'regular' | 'emergency';
  created_by: number;
}

export interface Agenda {
  id: number;
  meeting_id: number;
  title: string;
  description: string;
  order_no: number;
  status: 'pending' | 'discussed' | 'approved' | 'rejected';
  created_by: number;
}

export interface Attendance {
  id: number;
  meeting_id: number;
  user_id: number;
  member_name: string;
  status: 'pending' | 'attending' | 'absent' | 'maybe';
}
```

### 5.5 ユーティリティ関数

#### 5.5.1 API クライアント
```typescript
// utils/api.ts
import axios from 'axios';

const API_BASE_URL = process.env.NODE_ENV === 'production' 
  ? 'https://kitakitakita18.github.io/p05'
  : 'http://localhost:5105';

const api = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 認証トークンの自動付与
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});
```

#### 5.5.2 認証ユーティリティ
```typescript
// utils/auth.ts
export const saveToken = (token: string) => {
  localStorage.setItem('token', token);
};

export const getToken = (): string | null => {
  return localStorage.getItem('token');
};

export const removeToken = () => {
  localStorage.removeItem('token');
};
```

## 6. 権限管理

### 6.1 ユーザー役割
1. **admin（管理者）**
   - 全機能にアクセス可能
   - ユーザー管理
   - 組合情報管理

2. **chairperson（理事長）**
   - 理事会の作成・編集・削除
   - 議題管理
   - 出席管理

3. **board_member（理事）**
   - 理事会への参加・コメント
   - 議題の閲覧・コメント
   - 出席回答

4. **resident（住民）**
   - お知らせの閲覧
   - ゴミカレンダーの閲覧

### 6.2 機能別アクセス制御

| 機能 | admin | chairperson | board_member | resident |
|------|-------|-------------|--------------|----------|
| ユーザー管理 | ✓ | ✗ | ✗ | ✗ |
| 組合情報管理 | ✓ | ✗ | ✗ | ✗ |
| 理事会作成・編集 | ✓ | ✓ | ✗ | ✗ |
| 議題作成・編集 | ✓ | ✓ | ✗ | ✗ |
| 理事会参加 | ✓ | ✓ | ✓ | ✗ |
| 議題閲覧 | ✓ | ✓ | ✓ | ✗ |
| お知らせ閲覧 | ✓ | ✓ | ✓ | ✓ |

## 7. セキュリティ

### 7.1 認証・認可
- **JWT トークン**: 24時間有効期限
- **パスワードハッシュ化**: bcrypt（開発環境では平文、本番環境では要実装）
- **CORS設定**: 必要なオリジンのみ許可
- **認証ミドルウェア**: 全APIエンドポイントで認証チェック

### 7.2 入力検証
- **SQLインジェクション対策**: パラメータ化クエリ
- **XSS対策**: 入力値のサニタイズ
- **CSRFトークン**: 状態変更APIで実装検討

### 7.3 ファイルアップロード
- **ファイルサイズ制限**: 設定可能
- **ファイル形式制限**: MIME タイプチェック
- **アップロード先**: `server/uploads/`

## 8. 開発・運用

### 8.1 開発コマンド
```bash
# 依存関係インストール
npm install
cd client && npm install

# 開発サーバー起動（同時起動）
npm run dev

# 個別起動
npm run server  # バックエンド（ポート5105）
npm run client  # フロントエンド（ポート3105）

# ビルド
npm run build

# 型チェック
npm run typecheck

# リント
npm run lint
```

### 8.2 デプロイメント
- **本番環境**: GitHub Pages
- **ビルド**: React本番ビルド
- **サーバー**: Node.js + Express
- **データベース**: PostgreSQL

### 8.3 環境変数
```env
# server/.env
NODE_ENV=production
PORT=5105
JWT_SECRET=your-secret-key
DATABASE_URL=postgresql://user:password@localhost/dbname
```

## 9. 機能詳細

### 9.1 ダッシュボード
- 次回理事会の表示
- 最近の理事会履歴
- 重要なお知らせ
- 議題ステータス概要

### 9.2 理事会管理
- 理事会の作成・編集・削除
- 日時・場所・内容の設定
- 状態管理（暫定・確定・完了・キャンセル）
- 出席者管理と出席確認メール送信
- 議事録ファイルの管理

### 9.3 議題管理
- 議題の作成・編集・削除
- 議題の順序変更
- 優先度設定（S・A・B・C）
- 進捗状況管理
- 関連文書の添付

### 9.4 出席管理
- 出席状況の一覧表示
- 個別出席回答
- 一括出席管理
- 出席率の集計

### 9.5 文書管理
- 議題関連文書のアップロード
- 議事録ファイルの管理
- ファイルダウンロード機能
- ファイル削除機能

### 9.6 ユーザー管理（管理者のみ）
- ユーザーの作成・編集・削除
- 役割の変更
- パスワードリセット

### 9.7 組合情報管理（管理者のみ）
- 組合基本情報の設定
- 定例理事会の開催設定
- 理事長情報の管理
- 自動スケジュール生成

## 10. 今後の拡張予定

### 10.1 メール機能
- 出席確認メール自動送信
- リマインダーメール
- 議事録共有メール

### 10.2 通知機能
- リアルタイム通知
- プッシュ通知
- スケジュール通知

### 10.3 レポート機能
- 出席率レポート
- 議題進捗レポート
- 年間活動レポート

### 10.4 モバイル対応
- レスポンシブデザイン強化
- モバイルアプリ化検討

## 11. 既知の制限事項

### 11.1 技術的制限
- SQLiteは開発環境のみ対応
- メール送信機能は実装されていない
- リアルタイム通知は未実装

### 11.2 運用上の制限
- ファイルサイズ制限は設定により調整が必要
- 同時接続数の制限は未設定
- バックアップ機能は手動実行

## 12. サポート・保守

### 12.1 ログ管理
- アクセスログ
- エラーログ
- デバッグログ

### 12.2 監視項目
- サーバー稼働状況
- データベース接続状況
- API応答時間
- エラー発生率

### 12.3 メンテナンス
- 定期的なデータベースバックアップ
- セキュリティアップデート
- 機能追加・バグ修正

---

**作成日**: 2025年7月15日  
**版数**: 1.0  
**作成者**: システム開発チーム  
**更新履歴**: 初回作成